---
version: "2.0"
endpoints:
  web-ip:
    kind: ip

services:
  bee:
    image: ethersphere/bee:2.6.0
    expose:
      - port: 1633
        as: 1633
        to:
          - global: false
          - service: varnish
      - port: 1634
        as: 1634
        to:
          - global: false
          - service: varnish
    env:
      - BEE_API_ADDR=:1633
      - BEE_FULL_NODE=false
      - BEE_SWAP_ENABLE=false
      - BEE_PASSWORD=flummoxedgranitecarrot
      - BEE_BLOCKCHAIN_RPC_ENDPOINT=https://xdai.fairdatasociety.org
      - BEE_CORS_ALLOWED_ORIGINS=*
    command:
      - bee
    args:
      - start

  caddy:
    image: ghcr.io/o8-is/swarm-router-caddy:0.1.0
    expose:
      - port: 80
        as: 80
        to:
          - global: true
            ip: web-ip
      - port: 443
        as: 443
        to:
          - global: true
            ip: web-ip
    command:
      - caddy
    args:
      - run
      - --config
      - /etc/caddy/Caddyfile

  varnish:
    image: octalmage/swarm-varnish:0.1.5
    expose:
      - port: 8080
        as: 8080
        to:
          - global: false
          - service: caddy
      - port: 6081
        as: 6081
        to:
          - global: false
    env:
      - VARNISH_SIZE=256M
    command:
      - varnishd
    args:
      - -F
      - -a
      - :8080
      - -f
      - /etc/varnish/default.vcl
      - -s
      - malloc,256M

  gatekeeper:
    image: ghcr.io/o8-is/swarm-router-gatekeeper:latest
    expose:
      - port: 9123
        as: 9123
        to:
          - global: false
          - service: caddy
    env:
      - PORT=9123

profiles:
  compute:
    bee:
      resources:
        cpu:
          units: 2
        memory:
          size: 2Gi
        storage:
          - size: 2Gi
    caddy:
      resources:
        cpu:
          units: 1
        memory:
          size: 512Mi
        storage:
          - size: 1Gi
    varnish:
      resources:
        cpu:
          units: 1
        memory:
          size: 512Mi
        storage:
          - size: 500Mi
    gatekeeper:
      resources:
        cpu:
          units: 0.5
        memory:
          size: 128Mi
        storage:
          - size: 100Mi

  placement:
    dc1:
      pricing:
        bee:
          denom: uakt
          amount: 1000
        caddy:
          denom: uakt
          amount: 1000
        varnish:
          denom: uakt
          amount: 1000
        gatekeeper:
          denom: uakt
          amount: 500
      signedBy:
        anyOf:
          - akash1365yvmc4s7awdyj3n2sav7xfx76adc6dnmlx63
      attributes:
        host: akash

deployment:
  bee:
    dc1:
      profile: bee
      count: 1
  caddy:
    dc1:
      profile: caddy
      count: 1
  varnish:
    dc1:
      profile: varnish
      count: 1
  gatekeeper:
    dc1:
      profile: gatekeeper
      count: 1
